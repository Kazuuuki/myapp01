# AIボット機能 概要（チャット＋画像）

## 実現したいことの概略
- チャットベースでトレーニング提案とフォーム指導を行う。
- ユーザーはテキストと画像（フォーム写真）を送るだけで、
  - 優先度つきの改善ポイント
  - 安全上の注意
  - 次に試すべき修正案
  を受け取れる。
- アプリ起動時または初回に「パーソナルデータ」を登録してもらい、
  毎回のプロンプトに自動で付与する。
  例: 身長、体重、目指す姿、トレーニング頻度、強度など。
- さらに毎回のプロンプトに載せたい追加情報（例）:
  - 年齢 / 性別（推定不要・入力任意）
  - 経験年数（初心者〜上級）
  - 可動域・柔軟性に関する自己評価
  - 既往歴 / 痛み・違和感のある部位（医療助言回避のため注意喚起にも使う）
  - 設備・利用可能な器具（自宅/ジム、バーベル/ダンベル/マシン等）
  - 競技・目的（筋肥大 / 減量 / パフォーマンス向上 など）
  - 1回のトレーニング時間の上限
  - 重点部位（例: 胸 / 背中 / 下半身 など）
  - 苦手種目 / 避けたい種目
- 過去のトレーニング履歴（頻度・種目・ボリューム・スタイル）を文脈として使い、
  「その人に合った」指導内容にする。
- データの直接編集は行わず、助言と提案に特化する。

## 送信する履歴サマリの具体イメージ（例）
```
# Profile
age: 30, sex: male, height_cm: 175, weight_kg: 72
goal: 筋肥大 / 背中強化
frequency: 週3, session_duration_min: 60
equipment: ジム（バーベル/ダンベル/マシン）
injury: 右肩に違和感（押し系は痛みが出る）

# 4-week summary
weekly_sessions_avg: 2.8
volume_top5:
  - squat: 8,400kg
  - bench: 6,100kg
  - deadlift: 7,500kg
  - row: 5,200kg
  - pulldown: 4,600kg
focus_balance:
  upper: 55%, lower: 45%
intensity_trend:
  - bench 1RM推定: 85 -> 90
  - squat 1RM推定: 115 -> 112
fatigue_signal:
  - 連続2週でRPE高止まり、回復遅め

# last_sessions (max 2–3)
- 2026-01-27: upper
  exercises: bench 5x5@70, row 4x10@45, pulldown 3x12@40
  RPE: 8-9, notes: 肩が痛む
- 2026-01-24: lower
  exercises: squat 5x5@90, RDL 4x8@70, legpress 3x12@160
  RPE: 8, notes: 腰はOK
```

## この情報でできる提案例（イメージ）
- 肩の痛みがあるので、押し種目の量を2週間減らし、フォーム再評価を優先。
- 背中強化目的に対してロー/プル系のボリュームが低めなので、週1で背中のボリュームを増やす。
- スクワットの推定1RMが下がり気味なので、疲労高めと判断し1週間のデロードを提案。

## Expo側でやること
### 1) UI / UX
- チャット画面を追加（テキスト入力＋画像添付＋送信）。※下のタブに「chat」を追加する
- 送信中 / 失敗時のリトライ / 画像プレビュー。
- 返答メッセージの構造化表示（例: 優先度順の箇条書き）。

### 2) 画像取得
- `expo-image-picker` でカメラ or ライブラリから画像取得。
- 画像のリサイズ/圧縮（アップロード時間とコスト最適化）。

### 3) 画像アップロード
- APIから「署名付きURL」を取得。
- 画像をS3へPUTアップロード。
- 成功後、画像URLとメタ情報をチャット送信ペイロードに含める。

### 4) 履歴サマリの作成
- SQLiteから直近4週間などの履歴を取得。
- 例:
  - 週あたりのトレーニング頻度
  - 種目の上位5つ
  - 種目別の平均ボリューム
  - 継続傾向 / 休止傾向
- 文字数を抑えたテキストサマリに整形して API に送信。

### 5) チャット送信
- APIへ「テキスト＋画像URL＋履歴サマリ＋種目名（任意）」を送る。
- 応答をチャットに表示。

### 6) ローカル設定
- 環境変数や設定ファイルにAPIエンドポイントを格納。
- ネットワーク失敗時のフォールバック表示。

## AWS側でやること
### 1) API
- API Gateway + Lambda（or ECS/Fargate）でエンドポイントを用意。
- エンドポイント例:
  - `POST /media/sign-url`（署名付きURL発行）
  - `POST /ai/chat`（チャット推論）

### 2) 署名付きURL発行
- S3に短時間有効のPUT用URLを生成。
- ファイルサイズ制限とContent-Type検証。

### 3) 推論（Bedrock）
- Bedrock Converse API を使用。
- 入力:
  - ユーザーテキスト
  - 画像URL（S3）
  - 履歴サマリ
  - システム指示（安全・医学的配慮の注意）
- 出力:
  - 優先度付きのフォーム修正
  - 注意書き（医療行為でない旨）

### 4) プロンプト整形
- 履歴サマリを短く組み込むテンプレートを用意。
- 出力フォーマットを固定（JSON or Markdown）しフロントで表示しやすくする。

### 5) ガードレール
- Bedrock Guardrails で不適切な内容や危険助言をブロック。
- 画像コンテンツの安全フィルタを有効化。

### 6) 監視 / ログ
- CloudWatchにリクエスト、エラー、レイテンシを記録。
- 異常時にアラート。

### 7) セキュリティ
- APIキー or Cognitoで簡易認証。
- S3バケットは公開禁止、署名URLのみ許可。

## 実装の最小ステップ（MVP）
1. Expo: チャット画面 + 画像添付UI
2. AWS: 署名URL発行API + S3アップロード
3. AWS: Bedrock推論API
4. Expo: チャット送信 + 応答表示
5. 履歴サマリを結合して文脈を追加

## 注意点
- 画像サイズが大きいとコストとレイテンシが急増するため、
  送信前のリサイズ/圧縮は必須。
- 「医療アドバイスではない」旨を出力に含める。
- 返答の構造化（JSONなど）にしておくとUXが安定する。

