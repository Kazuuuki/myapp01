# 履歴カレンダーUI 実装計画

## 目的
- トレーニング履歴をカレンダー形式で表示する。
- 日付をタップすると、その日のトレーニング記録を開く。
- 過去日付も Today と同様に追加・編集できる。

## 現状スナップショット（2026-01-31 時点）
- 履歴一覧: `app/(tabs)/explore.tsx` でセッション統計を一覧表示し、`app/session/[id].tsx` に遷移。
- 保存構造: `workout_sessions`（`date` / `start_time`）＋ `session_exercises` / `set_records`。
- Today 流れ: `getOrCreateTodaySession` と today 画面の usecase が 1 日のデータを操作。

## 提案UX
1. 履歴タブをカレンダー画面に変更。
2. セッションがある日付にドット/バッジを表示。
3. 日付をタップ:
   - セッションがある場合: その日の詳細を開く。
   - セッションがない場合: 空のデイビューを開き「追加」CTAを表示。
4. デイビューで当該日付の種目/セットを追加できるようにする（Today 限定にしない）。

## データ/ユースケース変更
1. **カレンダー用データ**
   - 月表示用に日付範囲でセッションを取得する usecase を追加:
     - `listSessionDatesInRange(startDate, endDate)`
     - 返却: `date`, `sessionId`, `exerciseCount`, `setCount`（またはマーキング用の件数のみ）
   - カレンダーの印付けを高速化するため `date` 単位で GROUP BY。
2. **Today を「選択日付」に一般化**
   - `getOrCreateSessionByDate(date)` を追加して `getOrCreateTodaySession` を置換/拡張。
   - today 画面は date パラメータを受け取り（デフォルトは今日）で動作させる。
3. **日付でのセッション詳細**
   - `getSessionByDateWithDetail(date)` を追加し、sessionId を解決して詳細を取得。
   - 1日複数セッションを許容する場合は、以下を決定:
     - その日の一覧を表示する、または
     - マージする（非推奨）、または
     - 1日1セッションに制約する。

## UI / ナビゲーション変更
1. **カレンダー画面**（`app/(tabs)/explore.tsx`）
   - リストをカレンダーコンポーネントに置き換え。
   - 推奨ライブラリ: `react-native-calendars`（Expo 互換性を確認）。
   - セッション有無でマーク表示、選択日の概要を下部に表示。
2. **日付詳細画面**
   - 新規ルート: `app/history/[date].tsx`（YYYY-MM-DD）。
   - その日の詳細と編集/追加を表示。
   - Today 画面の追加UIコンポーネントを再利用。
3. **Today 画面更新**
   - `date` パラメータを受け取れるようにリファクタし、`history/[date]` から再利用。

## 検討事項 / エッジケース
- **1日複数セッション**: 許容可否を決める。禁止なら repo/usecase で制約。
- **タイムゾーン**: 日付キーはローカル日付（YYYY-MM-DD）で統一。
- **空日付**: 過去日でもセッションを作成できるように明確なCTAを設置。

## 実装ステップ
1. カレンダー範囲取得と日付別セッション取得の usecase を追加。
2. 日付範囲/日付検索の repo クエリを追加/調整。
3. `app/(tabs)/explore.tsx` にカレンダーUIを実装し、マークを連携。
4. `app/history/[date].tsx` を追加し、Today のUIを流用して編集可能にする。
5. Today 画面を date 指定対応にリファクタ。
6. 簡易テスト（可能なら）または手動QAチェックリストを作成。

## QAチェックリスト
- カレンダーにセッションがある日付がマーク表示される。
- 日付タップで正しい画面に遷移する。
- セッションがない日付で追加作成できる。
- 過去日で編集した内容が保存され、カレンダーに反映される。
- Today 画面の挙動は変わらず（デフォルト date = 今日）。
